---
title: "[Implementation] AVSR - decoder batch issue"
date: 2022-12-05 18:20:00 -0400
categories: Implementation
---

## Issue

Batch에 따라 inference가 제각각인 경우 발생

ex) 똑같은 input임에도 불구하고 속한 batch에 따라 추론 결과가 다름.

Tar: ㅇㅗㄴㅡ\ㄹ ㅇㅕㅈㅏㅊㅣ\ㄴㄱㅜㄱㅏ ㅇㅗ\ㄴㄷㅏㄱㅗ ㅎㅐㅅㅓ ㅁㅏ\ㅅㅇㅣ\ㅆㄴㅡ\ㄴ ㅍㅏㅅㅡㅌㅏㅇㅘ ㅁㅏㅋㅏㄹㅗ\ㅇㅇㅡ\ㄹ ㅁㅏ\ㄴㄷㅡ\ㄹㅇㅓ ㅈㅝ\ㅆㅇㅓ \
Out: ㅇㅗㄴㅡ\ㄹ ㅇㅕㅈㅏㅊㅣ\ㄴㄱㅜㄱㅏ ㅇㅗ\ㄴㄷㅏㄱㅗ ㅎㅐㅅㅓ ㅁㅏ\ㅅㅇㅣ\ㅆㄴㅡ\ㄴ ㅍㅏㅅㅡㅌㅏㅇㅘ ㅁ \
lip_J_1_F_01_C281_A_007,006 \
Tar: ㅇㅣㅂㅓ\ㄴ ㅈㅜㅁㅏ\ㄹㅇㅔ ㅇㅐㄷㅡ\ㄹ ㄷㅏ ㅂㅜ\ㄹㄹㅓㅅㅓ ㅊㅜ\ㄱㄱㅜ ㄱㅕ\ㅇㄱㅣㄹㅡ\ㄹ ㅎㅏㅈㅏ \
Out: ㅇㅣㅂㅓ\ㄴ ㅈㅜㅁㅏ\ㄹㅇㅔ ㅇㅐㄷㅡ\ㄹ ㄷㅏ ㅂㅜ\ㄹㄹㅓㅅㅓ ㅊㅜ\ㄱㄱㅜ ㄱㅕ\ㅇㄱㅣㄹㅡ\ㄹ ㅎㅏㅈㅏ \
lip_J_1_M_01_E205_A_009,017 \
\---------------------------------------------------------------------------------------------------------------------------------------------------------------------
Tar: ㅇㅗㄴㅡ\ㄹ ㅇㅕㅈㅏㅊㅣ\ㄴㄱㅜㄱㅏ ㅇㅗ\ㄴㄷㅏㄱㅗ ㅎㅐㅅㅓ ㅁㅏ\ㅅㅇㅣ\ㅆㄴㅡ\ㄴ ㅍㅏㅅㅡㅌㅏㅇㅘ ㅁㅏㅋㅏㄹㅗ\ㅇㅇㅡ\ㄹ ㅁㅏ\ㄴㄷㅡ\ㄹㅇㅓ ㅈㅝ\ㅆㅇㅓ \
Out: ㅇㅗㄴㅡ\ㄹ ㅇㅕㅈㅏㅊㅣ\ㄴㄱㅜㄱㅏ ㅇㅗ\ㄴㄷㅏㄱㅗ ㅎㅐㅅㅓ ㅁㅏ\ㅅㅇㅣ\ㅆㄴㅡ\ㄴ ㅍㅏㅅㅡㅌㅏㅇㅘ ㅁ**ㅏㅋㅏㄹㅗ\ㅇㅇㅡ\ㄹ ㅁㅏ\ㄴㄷㅡ\ㄹㅇㅓ ㅈㅝ\ㅆㅇㅓ\ㅆ** \
lip_J_1_F_01_C281_A_007,006 \
Tar: ㄴㅐㄱㅏ ㄲㅜ\ㅁㄲㅜㄴㅡ\ㄴ ㅇㅘ\ㄴㅂㅕ\ㄱㅎㅏ\ㄴ ㅎㅠㄱㅏㄴㅡ\ㄴ ㅎㅐㅂㅕ\ㄴㅇㅔ ㅇㅣ\ㅆㄴㅡ\ㄴ ㅍㅏㄹㅏㅅㅗ\ㄹ ㅁㅣ\ㅌㅇㅔ ㄴㅜㅇㅝㅅㅓ ㅎㅏ\ㄴㅅㅜ\ㅁ ㅈㅏㄴㅡ\ㄴ ㄱㅓㅇㅑ \
Out: ㄴㅐㄱㅏ ㄲㅜ\ㅁㄲㅜㄴㅡ\ㄴ ㅇㅘ\ㄴㅂㅕ\ㄱㅎㅏ\ㄴ ㅎㅠㄱㅏㄴㅡ\ㄴ ㅎㅐㅂㅕ\ㄴㅇㅔ ㅇㅣ\ㅆㄴㅡ\ㄴ ㅍㅏㄹㅏㅅㅗ\ㄹ ㅁㅣ\ㅌㅇㅔ ㄴㅜㅇㅝㅅㅓ ㅎㅏ\ㄴㅅㅜ\ㅁ ㅈㅏㄴㅡ\ㄴ ㄱㅓㅇㅑ \
lip_J_1_M_02_C319_A_002,015 \

## Solution

시도

1. Data collater 확인
2. Encoder 확인
3. Decoding process 확인

최종

Decoding 과정에서 Att score가 누적되는데, 이 때 이전 step에서의 score가 batch 사이에 공유되었음 (vector가 아닌 scalar값으로 사용되고 있었음)

ndarray로 수정하여 해결.
